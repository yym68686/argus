services:
  # Builds the runtime TCP bridge image that the gateway will spawn dynamically.
  # This container exits immediately; the image is what's needed.
  runtime-image:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        APP_SERVER_INSTALL_CMD: ${ARGUS_RUNTIME_INSTALL_CMD:-npm i -g @openai/codex}
    image: argus-runtime
    command: ["sh", "-lc", "echo 'runtime image built'"]

  gateway:
    build:
      context: .
      dockerfile: apps/api/Dockerfile
    image: argus-gateway
    depends_on:
      - runtime-image
    environment:
      ARGUS_PROVISION_MODE: docker
      ARGUS_RUNTIME_IMAGE: argus-runtime
      ARGUS_DOCKER_NETWORK: argus-net
      ARGUS_HOME_HOST_PATH: ${ARGUS_HOME_HOST_PATH:-/srv/argus}
      ARGUS_WORKSPACE_HOST_PATH: ${ARGUS_WORKSPACE_HOST_PATH:-/srv/argus/workspace}
      # Command executed inside each spawned runtime container.
      ARGUS_RUNTIME_CMD: ${ARGUS_RUNTIME_CMD:-codex app-server}
      # Optional: require auth for /ws (Authorization: Bearer ... or ?token=...).
      ARGUS_TOKEN: ${ARGUS_TOKEN:-}
      # Optional: separate auth scopes (fallback to ARGUS_TOKEN when unset).
      ARGUS_NODE_TOKEN: ${ARGUS_NODE_TOKEN:-}
      ARGUS_MCP_TOKEN: ${ARGUS_MCP_TOKEN:-}
      # Optional: docker provision tuning.
      ARGUS_CONNECT_TIMEOUT_S: ${ARGUS_CONNECT_TIMEOUT_S:-30}
      ARGUS_CONTAINER_PREFIX: ${ARGUS_CONTAINER_PREFIX:-argus-session}
    volumes:
      # WARNING: mounting the Docker socket grants root-equivalent access to the host.
      - ${DOCKER_SOCK:-/var/run/docker.sock}:/var/run/docker.sock
    ports:
      - "8080:8080"
    networks:
      - argus-net
    restart: unless-stopped

  web:
    profiles: ["web"]
    build:
      context: ./apps/web
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_ARGUS_WS_URL: ${NEXT_PUBLIC_ARGUS_WS_URL:-}
    image: argus-web
    ports:
      - "3000:80"
    restart: unless-stopped

  telegram-bot:
    profiles: ["tg"]
    build:
      context: ./apps/telegram-bot
      dockerfile: Dockerfile
    image: argus-telegram-bot
    environment:
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:-}
      ARGUS_TOKEN: ${ARGUS_TOKEN:-}
      HOST: ${HOST:-gateway}
    volumes:
      - telegram-bot-data:/data
    networks:
      - argus-net
    restart: unless-stopped

networks:
  argus-net:
    name: argus-net

volumes:
  telegram-bot-data:
    name: argus-telegram-bot-data
